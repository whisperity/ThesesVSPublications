\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{thesesvspublications}[2020/10/23 v0.1 Theses vs. Publications table generator]

\RequirePackage{etoolbox}
\RequirePackage{forloop}
\RequirePackage{ifthen}
\RequirePackage{xparse}

\ExplSyntaxOn
% (via https://tex.stackexchange.com/a/300215)
\NewExpandableDocumentCommand{\egreg@Repeat}{O{}mm}
 {
  \int_compare:nT { #2 > 0 }
   {
    #3 \prg_replicate:nn { #2 - 1 } { #1#3 }
   }
 }
\ExplSyntaxOff

%% Internal cursors that are used for various iteration purposes.
\newcounter{tvp@CursorT}
\newcounter{tvp@CursorP}
\newcounter{tvp@CursorC}

%% The total number of theses defined.
\newcounter{tvp@ThesisCount}

%% Returns the number of theses that are defined.
\newrobustcmd{\numtheses}{\the\value{tvp@ThesisCnt}}

%% \definethesis{<key>}{<title>}{<thesis summary>}
%% defines the given thesis with the key.
\newrobustcmd{\definethesis}[3]{%
    \stepcounter{tvp@ThesisCount}%
    % 
    \listcsgadd{tvp@Theses}{#1}%
    \expandafter\def\csname tvp@Theses@\thetvp@ThesisCount\endcsname{#1}%
    \expandafter\def\csname tvp@ThesisTitles@\thetvp@ThesisCount\endcsname{#2}%
    \expandafter\def\csname tvp@ThesisTexts@\thetvp@ThesisCount\endcsname{#3}%
}

%% Retrieve the name for the <index>th thesis.
\newcommand{\tvp@ThesisName}[1]{\csname tvp@Theses@#1\endcsname}
%% Retrieve the title for the <index>th thesis.
\newcommand{\tvp@ThesisTitle}[1]{\csname tvp@ThesisTitles@#1\endcsname}
%% Retrieve the thesis summary for the <index>th thesis.
\newcommand{\tvp@ThesisText}[1]{\csname tvp@ThesisTexts@#1\endcsname}

%% Internal command which sets the counter tvp@CursorT to the index of the
%% thesis with the given <key>.
\newcommand\tvp@FindThesisIndex[1]{%
    \renewcommand*{\do}[1]{%
        \ifstrequal{##1}{#1}%
            {\listbreak}%
            {\stepcounter{tvp@CursorT}}%
    }%
    \setcounter{tvp@CursorT}{0}%
    \dolistcsloop{tvp@Theses}%
    \stepcounter{tvp@CursorT}%
    %
    \ifnumgreater{\value{tvp@CursorT}}{\value{tvp@ThesisCount}}{%
        \PackageError{thesesvspublications}{Requested information about thesis '#1' but it doesn't exist}{%
            Check that functions such as \detokenize{\thesistitle} are not given undefined thesis keys!}%
    }%
}

%% Retrieve the title for the thesis defined as <key>.
\newrobustcmd{\thesistitle}[1]{%
    \tvp@FindThesisIndex{#1}%
    \tvp@ThesisTitle{\thetvp@CursorT}%
}

%% Retrieve the thesis summary for the thesis defined as <key>.
\newrobustcmd{\thesissummary}[1]{%
    \tvp@FindThesisIndex{#1}%
    \tvp@ThesisText{\thetvp@CursorT}%
}


%% The total number of publications defined.
\newcounter{tvp@PublicationCount}

%% Returns the number of publications that are defined.
\newrobustcmd{\numpublications}{\the\value{tvp@ThesisCnt}}

%% \definethesis{<key>}{<text>}
%% defines the given publication text body with the given key.
\newrobustcmd{\definepublication}[2]{%
    \stepcounter{tvp@PublicationCount}%
    % 
    \listcsgadd{tvp@Publications}{#1}%
    \expandafter\def\csname tvp@Publications@\thetvp@PublicationCount\endcsname{#1}%
    \expandafter\def\csname tvp@PublicationTexts@\thetvp@PublicationCount\endcsname{#2}%
}

%% Retrieve the name for the <index>th publication.
\newcommand{\tvp@PublicationName}[1]{\csname tvp@Publications@#1\endcsname}
%% Retrieve the title for the <index>th publication.
\newcommand{\tvp@PublicationText}[1]{\csname tvp@PublicationTexts@#1\endcsname}

%% Internal command which sets the counter tvp@CursorP to the index of the
%% publication with the given <key>.
\newcommand\tvp@FindPublicationIndex[1]{%
    \renewcommand*{\do}[1]{%
        \ifstrequal{##1}{#1}%
            {\listbreak}%
            {\stepcounter{tvp@CursorP}}%
    }%
    \setcounter{tvp@CursorP}{0}%
    \dolistcsloop{tvp@Publications}%
    \stepcounter{tvp@CursorP}%
    %
    \ifnumgreater{\value{tvp@CursorP}}{\value{tvp@PublicationCount}}{%
        \PackageError{thesesvspublications}{Requested information about publication '#1' but it doesn't exist}{%
            Check that functions such as \detokenize{\publication} are not given undefined publication keys!}%
    }%
}

%% Retrieve the text for the publication defined as <key>.
\newrobustcmd{\publication}[1]{%
    \tvp@FindPublicationIndex{#1}%
    \tvp@PublicationText{\thetvp@CursorP}%
}

%% assignpublication <publication-key> <thesis-key>
%% assigns the given publication to be relevant for the given thesis.
\newrobustcmd{\assignpublication}[2]{%
    \tvp@FindThesisIndex{#2}     % CursorT set.
    \tvp@FindPublicationIndex{#1}% CursorP set.
    % Format is: (thesis,publication) pairs in the list.
    \listcsxadd{tvp@AssignMatrix}{(\tvp@ThesisName{\thetvp@CursorT},\tvp@PublicationName{\thetvp@CursorP})}%
}

%% Renders the heading of the table.
\newcommand{\tvp@RenderHeading}{%
    \setcounter{tvp@CursorP}{\value{tvp@PublicationCount}}%
    \stepcounter{tvp@CursorP}%
    %
    Thesis name%
    \forloop{tvp@CursorC}{1}{\value{tvp@CursorC} < \value{tvp@CursorP}}{%
        & \tvp@PublicationText{\thetvp@CursorC}%
    }%
}

%% tvp@ThesisPublicationAssigned {<thesis-key>} {<publication-key>} {<if-true>} {<if-false>}
%% If the publication given is assigned by the client to the thesis given, executes
%% <if-true>, otherwise, <if-false>.
\newcommand{\tvp@ThesisPublicationAssigned}[4]{%
    \xifinlistcs{(#1,#2)}{tvp@AssignMatrix}{#3}{#4}%
}

%% Internal toggle that specifies whether the current row of \ThesesVSPublications
%% should be highlighted or not.
\newtoggle{tvp@IsCurrentRowHighlighted}

%% tvp@RowBlip{<thesis-key>}{<publication-key>}
%% Returns the visual blip part of the \ThesesVSPublications table.
\newcommand{\tvp@RowBlip}[2]{%
    \tvp@ThesisPublicationAssigned{#1}{#2}{%
        \iftoggle{tvp@IsCurrentRowHighlighted}{\textbullet}{\textopenbullet}%
    }{}%
}

%% tvp@RenderRow{<key>}
%% Renders the row for the thesis defined as <key>.
\newcommand{\tvp@RenderRow}[1]{%
    \tvp@FindThesisIndex{#1}%
    \thetvp@CursorT. \thesistitle{#1} %
    %
    \setcounter{tvp@CursorP}{\value{tvp@PublicationCount}}%
    \stepcounter{tvp@CursorP}%
    \forloop{tvp@CursorC}{1}{\value{tvp@CursorC} < \value{tvp@CursorP}}{%
        & \tvp@RowBlip{#1}{\tvp@PublicationName{\thetvp@CursorC}}%
    }%
}

\newcommand{\tvp@RowRenderHELPER}[1]{} % Dummy.

%% Typesets the Theses vs. Publications table.
%% The argument of <current-thesis> will highlight the row of the given thesis, if given.
\newcommand{\ThesesVSPublications}[1][0]{%
    \renewcommand{\tvp@RowRenderHELPER}[1]{%
        % Set highlight for current row.
        \ifthenelse{\equal{##1}{#1}}{%
            \global\toggletrue{tvp@IsCurrentRowHighlighted}%
        }{%
            \global\togglefalse{tvp@IsCurrentRowHighlighted}%
        }%
        % Set highlight for row if all row should be highlighted.
        \ifthenelse{\equal{#1}{0}}{%
            \global\toggletrue{tvp@IsCurrentRowHighlighted}%
        }{}%
        %
        \tvp@RenderRow{##1} \\
        \hline%
    }%
    %
    \begin{tabular}{|l|%
        \egreg@Repeat[|]{\expandafter\thetvp@PublicationCount}{c}%
        |%
    }
        \hline
        \tvp@RenderHeading \\
        \hline
        \forlistcsloop{\tvp@RowRenderHELPER}{tvp@Theses}%
    \end{tabular}%
}

\endinput
