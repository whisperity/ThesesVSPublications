%% thesesvspublications.sty
%% Copyright 2020 Whisperity
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% This work has the LPPL maintenance status `maintained'.
%
% The Current Maintainer of this work is Whisperity.
%
% This work consists of the files thesesvspublications.sty
% and thesesvspublications.tex.
%
\NeedsTeXFormat{LaTeX2e}[2017/01/01]
\ProvidesPackage{thesesvspublications}[2020/10/24 v1.0 Theses vs. Publications table generator]

\RequirePackage{etoolbox}
\RequirePackage{forloop}
\RequirePackage{ifthen}
\RequirePackage{textcomp}
\RequirePackage{xparse}

\newrobustcmd{\thesesvspublicationsReleaseDate}{2020/10/25}
\newrobustcmd{\thesesvspublicationsVersion}{1.0}

\ExplSyntaxOn
% (via http://tex.stackexchange.com/a/300215)
\NewExpandableDocumentCommand{\egreg@Repeat}{O{}mm}
 {
  \int_compare:nT { #2 > 0 }
   {
    #3 \prg_replicate:nn { #2 - 1 } { #1#3 }
   }
 }
\ExplSyntaxOff

%% Internal cursors that are used for various iteration purposes.
\newcounter{tvp@CursorT}
\newcounter{tvp@CursorP}
\newcounter{tvp@CursorC}

%% Internal data structure holding the thesis keys.
\newcommand{\tvp@Theses}{}

%% The total number of theses defined.
\newcounter{tvp@ThesisCount}

%% Returns the number of theses that are defined.
\newrobustcmd{\numtheses}{\the\value{tvp@ThesisCnt}}

%% Registers the thesis with the given key, title, and text/summary/description.
\newrobustcmd{\tvp@NewThesis}[2]{%
    \stepcounter{tvp@ThesisCount}%
    % 
    \listcsgadd{tvp@Theses}{#1}%
    \expandafter\def\csname tvp@Theses@\thetvp@ThesisCount\endcsname{#1}%
    \expandafter\def\csname tvp@ThesisTitles@\thetvp@ThesisCount\endcsname{#2}%
}
%% \definethesis{<key>}{<title>}{<thesis summary>}
%% defines the given thesis with the key.
\newrobustcmd{\definethesis}[2]{%
    \tvp@NewThesis{#1}{#2}%
}

%% Retrieve the name for the <index>th thesis.
\newcommand{\tvp@ThesisName}[1]{\csname tvp@Theses@#1\endcsname}
%% Retrieve the title for the <index>th thesis.
\newcommand{\tvp@ThesisTitle}[1]{\csname tvp@ThesisTitles@#1\endcsname}

%% Internal command which sets the counter tvp@CursorT to the index of the
%% thesis with the given <key>.
\newcommand\tvp@FindThesisIndex[1]{%
    \renewcommand*{\do}[1]{%
        \ifstrequal{##1}{#1}%
            {\listbreak}%
            {\stepcounter{tvp@CursorT}}%
    }%
    \setcounter{tvp@CursorT}{0}%
    \dolistcsloop{tvp@Theses}%
    \stepcounter{tvp@CursorT}%
    %
    \ifnumgreater{\value{tvp@CursorT}}{\value{tvp@ThesisCount}}{%
        \PackageError{thesesvspublications}{Requested information about thesis '#1' but it doesn't exist}{%
            Check that functions such as \detokenize{\thesistitle} are not given undefined thesis keys!}%
    }%
}

%% Retrieve the title for the thesis defined as <key>.
\newrobustcmd{\thesistitle}[1]{%
    \tvp@FindThesisIndex{#1}%
    \tvp@ThesisTitle{\thetvp@CursorT}%
}

%% Retrieve the thesis summary for the thesis defined as <key>.
\newrobustcmd{\thesissummary}[1]{%
    \tvp@FindThesisIndex{#1}%
    \tvp@ThesisText{\thetvp@CursorT}%
}

%% Internal data structure holding the publication keys.
\newcommand{\tvp@Publications}{}

%% The total number of publications defined.
\newcounter{tvp@PublicationCount}

%% Returns the number of publications that are defined.
\newrobustcmd{\numpublications}{\the\value{tvp@ThesisCnt}}

%% Registers the public with the given key, and body.
\newrobustcmd{\tvp@NewPublication}[2]{%
    \stepcounter{tvp@PublicationCount}%
    % 
    \listcsgadd{tvp@Publications}{#1}%
    \expandafter\def\csname tvp@Publications@\thetvp@PublicationCount\endcsname{#1}%
    \expandafter\def\csname tvp@PublicationTexts@\thetvp@PublicationCount\endcsname{#2}%
}
%% \definethesis{<key>}{<text>}
%% defines the given publication text body with the given key.
\newrobustcmd{\definepublication}[2]{%
    \tvp@NewPublication{#1}{#2}%
}

%% Retrieve the name for the <index>th publication.
\newcommand{\tvp@PublicationName}[1]{\csname tvp@Publications@#1\endcsname}
%% Retrieve the title for the <index>th publication.
\newcommand{\tvp@PublicationText}[1]{\csname tvp@PublicationTexts@#1\endcsname}

%% Internal command which sets the counter tvp@CursorP to the index of the
%% publication with the given <key>.
\newcommand\tvp@FindPublicationIndex[1]{%
    \renewcommand*{\do}[1]{%
        \ifstrequal{##1}{#1}%
            {\listbreak}%
            {\stepcounter{tvp@CursorP}}%
    }%
    \setcounter{tvp@CursorP}{0}%
    \dolistcsloop{tvp@Publications}%
    \stepcounter{tvp@CursorP}%
    %
    \ifnumgreater{\value{tvp@CursorP}}{\value{tvp@PublicationCount}}{%
        \PackageError{thesesvspublications}{Requested information about publication '#1' but it doesn't exist}{%
            Check that functions such as \detokenize{\publication} are not given undefined publication keys!}%
    }%
}

%% Retrieve the text for the publication defined as <key>.
\newrobustcmd{\publication}[1]{%
    \tvp@FindPublicationIndex{#1}%
    \tvp@PublicationText{\thetvp@CursorP}%
}

%% Internal data structure holding the thesis-to-publication assignments.
\newcommand{\tvp@AssignMatrix}{}

%% Sets that #1 publication is related to #2 thesis (both args are keys).
\newrobustcmd{\tvp@AssignPublicationToThesis}[2]{%
    \tvp@FindThesisIndex{#2}     % CursorT set.
    \tvp@FindPublicationIndex{#1}% CursorP set.
    % Format is: (thesis,publication) pairs in the list.
    \listcsxadd{tvp@AssignMatrix}{(\tvp@ThesisName{\thetvp@CursorT},\tvp@PublicationName{\thetvp@CursorP})}%
}
%% assignpublication <publication-key> <thesis-key>
%% assigns the given publication to be relevant for the given thesis.
\newrobustcmd{\assignpublication}[2]{%
    \tvp@AssignPublicationToThesis{#1}{#2}%
}

%% Clear all the internal data structures, undefine all commands, and reset all counters.
\newrobustcmd{\tvp@Reset}{%
    % Clear the data store macros:
    \forloop[-1]{tvp@CursorC}{\value{tvp@ThesisCount}}{\value{tvp@CursorC} > 0}{%
        \expandafter\def\csname tvp@Theses@\thetvp@CursorC\endcsname{}%
        \expandafter\def\csname tvp@ThesisTitles@\thetvp@CursorC\endcsname{}%
    }%
    \forloop[-1]{tvp@CursorC}{\value{tvp@PublicationCount}}{\value{tvp@CursorC} > 0}{%
        \expandafter\def\csname tvp@Publications@\thetvp@CursorC\endcsname{}%
        \expandafter\def\csname tvp@PublicationTexts@\thetvp@CursorC\endcsname{}%
    }%
    % Reset the lists and counters:
    \renewcommand{\tvp@Theses}{}%
    \setcounter{tvp@ThesisCount}{0}%
    \renewcommand{\tvp@Publications}{}%
    \setcounter{tvp@PublicationCount}{0}%
    \renewcommand{\tvp@AssignMatrix}{}%
    %
    \setcounter{tvp@CursorT}{0}%
    \setcounter{tvp@CursorP}{0}%
    \setcounter{tvp@CursorC}{0}%
    % Reset customisation.
    \tvp@Renderer@Reset%
}
%% DANGEROUS! Clear the internal data structures!
\newrobustcmd{\tvpReset}{%
    \tvp@Reset%
}

%% Renderer for the table's 1st cell.
\newcommand{\tvp@Renderer@Default@TopCorner}{Thesis name}
\newcommand{\tvp@Renderer@TopCorner}{} % Dummy.
\newrobustcmd{\tvpSetTopCorner}[1]{%
    \renewcommand{\tvp@Renderer@TopCorner}{#1}%
}

%% Renderer for the publication columns' first cells.
\newcommand{\tvp@Renderer@Default@PublicationHeading}[1]{#1}
\newcommand{\tvp@Renderer@PublicationHeading}{} % Dummy.
\newrobustcmd{\tvpSetPublicationHeading}[1]{%
    \renewcommand{\tvp@Renderer@PublicationHeading}{#1}%
}


%% Renders the heading of the table.
\newcommand{\tvp@TVP@RenderHeading}{%
    \setcounter{tvp@CursorP}{\value{tvp@PublicationCount}}%
    \stepcounter{tvp@CursorP}%
    %
    \tvp@Renderer@TopCorner{}%
    \forloop{tvp@CursorC}{1}{\value{tvp@CursorC} < \value{tvp@CursorP}}{%
        & \tvp@Renderer@PublicationHeading{\tvp@PublicationText{\thetvp@CursorC}}%
    }%
}

%% tvp@ThesisPublicationAssigned {<thesis-key>} {<publication-key>} {<if-true>} {<if-false>}
%% If the publication given is assigned by the client to the thesis given, executes
%% <if-true>, otherwise, <if-false>.
\newcommand{\tvp@ThesisPublicationAssigned}[4]{%
    \xifinlistcs{(#1,#2)}{tvp@AssignMatrix}{#3}{#4}%
}

%% Internal toggle that specifies whether the current row of \ThesesVSPublications
%% should be highlighted or not.
\newtoggle{tvp@AreAnyHighlightSet}
\newtoggle{tvp@IsCurrentRowHighlighted}

%% Renderer for the indicators in the rows.
\newcommand{\tvp@Renderer@Default@Indicator}{%
    \textbullet%
}
\newcommand{\tvp@Renderer@Default@Indicator@Highlighted@Current}{%
    \textbullet%
}
\newcommand{\tvp@Renderer@Default@Indicator@Highlighted@Other}{%
    \textopenbullet%
}
\newcommand{\tvp@Renderer@Indicator}{} % Dummy.
\newcommand{\tvp@Renderer@Indicator@Highlighted@Current}{} % Dummy.
\newcommand{\tvp@Renderer@Indicator@Highlighted@Other}{} % Dummy.
\newrobustcmd{\tvpSetIndicator}[1]{%
    \renewcommand{\tvp@Renderer@Indicator}{#1}%
}
\newrobustcmd{\tvpSetIndicatorHighlighted}[2]{%
    \renewcommand{\tvp@Renderer@Indicator@Highlighted@Current}{#1}%
    \renewcommand{\tvp@Renderer@Indicator@Highlighted@Other}{#2}%
}

%% tvp@TVP@Indicator{<thesis-key>}{<publication-key>}
%% Returns the visual blip part of the \ThesesVSPublications table.
\newcommand{\tvp@TVP@Indicator}[2]{%
    \tvp@ThesisPublicationAssigned{#1}{#2}{%
        \iftoggle{tvp@AreAnyHighlightSet}{%
            \iftoggle{tvp@IsCurrentRowHighlighted}{%
                \tvp@Renderer@Indicator@Highlighted@Current{}%
            }{%
                \tvp@Renderer@Indicator@Highlighted@Other{}%
            }%
        }{%
            \tvp@Renderer@Indicator{}%
        }%
    }{%
        % This field is intentionally left blank.
    }%
}

%% Renderer for the thesis entries in the rows.
\newcommand{\tvp@Renderer@Default@ThesisName}[2]{%
    #1. #2%
}
\newcommand{\tvp@Renderer@Default@ThesisName@Highlighted}[2]{%
    #1. \textbf{#2}%
}
\newcommand{\tvp@Renderer@ThesisName}{} % Dummy.
\newcommand{\tvp@Renderer@ThesisName@Highlighted}{} % Dummy.
\newrobustcmd{\tvpSetThesisName}[1]{%
    \renewcommand{\tvp@Renderer@ThesisName}{#1}%
}
\newrobustcmd{\tvpSetThesisNameHighlighted}[1]{%
    \renewcommand{\tvp@Renderer@ThesisName@Highlighted}{#1}%
}

%% tvp@TVP@RenderRow{<key>}
%% Renders the row for the thesis defined as <key>.
\newcommand{\tvp@TVP@RenderRow}[1]{%
    \tvp@FindThesisIndex{#1}%
    \iftoggle{tvp@AreAnyHighlightSet}{%
        \iftoggle{tvp@IsCurrentRowHighlighted}{%
            \tvp@Renderer@ThesisName@Highlighted{\thetvp@CursorT}{\thesistitle{#1}}%
        }{%
            \tvp@Renderer@ThesisName{\thetvp@CursorT}{\thesistitle{#1}}%
        }%
    }{%
        \tvp@Renderer@ThesisName{\thetvp@CursorT}{\thesistitle{#1}}%
    }%
    %
    \setcounter{tvp@CursorP}{\value{tvp@PublicationCount}}%
    \stepcounter{tvp@CursorP}%
    \forloop{tvp@CursorC}{1}{\value{tvp@CursorC} < \value{tvp@CursorP}}{%
        & \tvp@TVP@Indicator{#1}{\tvp@PublicationName{\thetvp@CursorC}}%
    }%
}

\newcommand{\tvp@TVP@RowRenderHELPER}[1]{} % Dummy.

%% Typesets the Theses vs. Publications table.
%% The argument of <current-thesis> will highlight the row of the given thesis, if given.
\newcommand{\tvp@TVP@MakeTabular}[1][0]{%
    \renewcommand{\tvp@TVP@RowRenderHELPER}[1]{%
        % Set the global toggle whether highlighting is enabled or not.
        \ifthenelse{\equal{#1}{0}}{%
            \global\togglefalse{tvp@AreAnyHighlightSet}%
        }{%
            \global\toggletrue{tvp@AreAnyHighlightSet}%
            % 
            % Set highlight for current row.
            \ifthenelse{\equal{##1}{#1}}{%
                \global\toggletrue{tvp@IsCurrentRowHighlighted}%
            }{%
                \global\togglefalse{tvp@IsCurrentRowHighlighted}%
            }%
        }%
        %
        \tvp@TVP@RenderRow{##1} \\
        \hline%
    }%
    %
    \begin{tabular}{|l|%
        \egreg@Repeat[|]{\expandafter\thetvp@PublicationCount}{c}%
        |%
    }
        \hline
        \tvp@TVP@RenderHeading \\
        \hline
        \forlistcsloop{\tvp@TVP@RowRenderHELPER}{tvp@Theses}%
    \end{tabular}%
}
\newrobustcmd{\ThesesVSPublications}{%
    \tvp@TVP@MakeTabular%
}

%% Resets the renderers to their default versions.
\newcommand{\tvp@Renderer@Reset}{%
    \renewcommand{\tvp@Renderer@TopCorner}{\tvp@Renderer@Default@TopCorner}%
    \renewcommand{\tvp@Renderer@PublicationHeading}[1]{\tvp@Renderer@Default@PublicationHeading{##1}}%
    \renewcommand{\tvp@Renderer@ThesisName}[2]{\tvp@Renderer@Default@ThesisName{##1}{##2}}%
    \renewcommand{\tvp@Renderer@ThesisName@Highlighted}[2]{\tvp@Renderer@Default@ThesisName@Highlighted{##1}{##2}}%
    \renewcommand{\tvp@Renderer@Indicator}{\tvp@Renderer@Default@Indicator}%
    \renewcommand{\tvp@Renderer@Indicator@Highlighted@Current}{\tvp@Renderer@Default@Indicator@Highlighted@Current}%
    \renewcommand{\tvp@Renderer@Indicator@Highlighted@Other}{\tvp@Renderer@Default@Indicator@Highlighted@Other}%
}
% Start the document with the renderers having the default version.
\tvp@Renderer@Reset

\endinput
